PREFIX : <http://example.org/restaurant#>
PREFIX foaf: <http://xmlns.com/foaf/0.1/>
PREFIX schema: <http://schema.org/>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

SELECT ?dishName
WHERE {
  # Retrieve Francesco's preferences
  :Client_Francesco :hasPreference ?preferences .
  ?preferences :maxCaloryIntake ?maxCaloryIntake ;
               :allergens ?allergenList ;
               :dietaryCategory ?dietaryCategory .

  # Get the menu sections and menu items
  ?menuSection schema:hasMenuItem ?dish .
  ?dish schema:name ?dishName ;
        schema:recipeIngredient ?ingredient .

  # Get ingredient details
  ?ingredient schema:calories ?calories ;
              schema:allergen ?ingredientAllergen ;
              schema:recipeCategory ?ingredientCategory .

  # Apply filters based on preferences
  FILTER (
    (
      (?maxCaloryIntake = "low" && xsd:integer(?calories) < 400) ||
      (?maxCaloryIntake = "medium" && xsd:integer(?calories) < 900) ||
      (?maxCaloryIntake = "high")
    ) &&
    (?dietaryCategory = ?ingredientCategory) &&
    (!CONTAINS(LCASE(?allergenList), LCASE(?ingredientAllergen)))
  )
}
GROUP BY ?dishName
HAVING (COUNT(?ingredient) = SUM(IF(
  (
    (?maxCaloryIntake = "low" && xsd:integer(?calories) < 400) ||
    (?maxCaloryIntake = "medium" && xsd:integer(?calories) < 900) ||
    (?maxCaloryIntake = "high")
  ) &&
  (?dietaryCategory = ?ingredientCategory) &&
  (!CONTAINS(LCASE(?allergenList), LCASE(?ingredientAllergen))),
  1, 0
)))
